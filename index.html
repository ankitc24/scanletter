<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>India Post Letter Scanner</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<style>
body { font-family: Arial; padding: 10px; }
video { width: 100%; border: 1px solid #000; }
button { width: 100%; padding: 10px; margin-top: 8px; }
table { width: 100%; border-collapse: collapse; margin-top: 15px; }
th, td { border: 1px solid black; padding: 6px; text-align: center; }
th { background: #eee; }
</style>
</head>

<body>

<h3>ðŸ“® India Post Auto Barcode Scanner</h3>

<video id="video" autoplay playsinline></video>

<button onclick="startIndiaPostScan()">Auto Scan India Post Barcode</button>
<button onclick="scanLetter()">Scan Letter (Name & Pincode)</button>

<table>
<thead>
<tr>
<th>Sl No</th>
<th>India Post Barcode</th>
<th>Name</th>
<th>Pincode</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

<canvas id="canvas" style="display:none;"></canvas>

<script>
let sl = 1;
let barcode = "";
let nameVal = "";
let pinVal = "";

const video = document.getElementById("video");

// Start camera
navigator.mediaDevices.getUserMedia({
    video: { facingMode: "environment" }
}).then(stream => video.srcObject = stream);

// Auto detect India Post barcode
async function startIndiaPostScan() {

    if (!("BarcodeDetector" in window)) {
        alert("Barcode scanning not supported on this browser");
        return;
    }

    const detector = new BarcodeDetector({
        formats: ["code_128"]
    });

    const indiaPostRegex = /^[A-Z]{2}[0-9]{9}IN$/;

    alert("Point camera towards India Post barcode");

    const scanInterval = setInterval(async () => {
        const detected = await detector.detect(video);

        if (detected.length > 0) {
            let value = detected[0].rawValue.toUpperCase();

            if (indiaPostRegex.test(value)) {
                barcode = value;
                clearInterval(scanInterval);
                alert("India Post Barcode Detected:\n" + barcode);
            }
        }
    }, 400);
}

// OCR Scan
function scanLetter() {
    const canvas = document.getElementById("canvas");
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext("2d").drawImage(video, 0, 0);

    Tesseract.recognize(canvas, "eng").then(({ data: { text } }) => {

        let cleaned = text.replace(/\n/g, " ").trim();

        // Only first two words for Name
        let words = cleaned.split(/\s+/);
        nameVal = words.slice(0, 2).join(" ");

        // Indian pincode
        let pinMatch = cleaned.match(/\b\d{6}\b/);
        pinVal = pinMatch ? pinMatch[0] : "";

        addRow();
    });
}

// Add row to table
function addRow() {
    if (!barcode) {
        alert("Scan India Post barcode first");
        return;
    }

    document.getElementById("tbody").innerHTML += `
    <tr>
        <td>${sl++}</td>
        <td>${barcode}</td>
        <td>${nameVal}</td>
        <td>${pinVal}</td>
    </tr>`;

    barcode = "";
    nameVal = "";
    pinVal = "";
}
</script>

</body>
</html>
