<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>India Post Letter Scanner</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://unpkg.com/@zxing/library@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<style>
body { font-family: Arial; padding: 10px; }
video { width: 100%; border: 2px solid black; }
button { width: 100%; padding: 10px; margin-top: 8px; }
table { width: 100%; border-collapse: collapse; margin-top: 15px; }
th, td { border: 1px solid black; padding: 6px; text-align: center; }
th { background: #eee; }
</style>
</head>

<body>

<h3>ðŸ“® India Post Barcode & Letter Scanner</h3>

<video id="video" autoplay playsinline muted></video>

<button onclick="startCamera()">Start Camera</button>
<button onclick="startBarcode()">Scan India Post Barcode</button>
<button onclick="scanLetter()">Scan Letter (Name & Pincode)</button>

<table>
<thead>
<tr>
<th>Sl No</th>
<th>Barcode</th>
<th>Name</th>
<th>Pincode</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

<canvas id="canvas" style="display:none;"></canvas>

<script>
let sl = 1;
let barcodeVal = "";
let nameVal = "";
let pinVal = "";
let stream = null;

const video = document.getElementById("video");
const codeReader = new ZXing.BrowserBarcodeReader();
const indiaPostRegex = /^[A-Z]{2}[0-9]{9}IN$/;

// ðŸ”¹ Start camera manually (IMPORTANT)
async function startCamera() {
    stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: "environment" }
    });
    video.srcObject = stream;
    await video.play();
}

// ðŸ”¹ Barcode scanning
function startBarcode() {
    if (!stream) {
        alert("Please start camera first");
        return;
    }

    codeReader.decodeFromVideoElement(video, (result, err) => {
        if (result) {
            let code = result.text.toUpperCase();
            if (indiaPostRegex.test(code)) {
                barcodeVal = code;
                codeReader.reset();
                alert("India Post Barcode Detected:\n" + barcodeVal);
            }
        }
    });
}

// ðŸ”¹ Letter OCR scanning
function scanLetter() {
    if (!stream) {
        alert("Please start camera first");
        return;
    }

    const canvas = document.getElementById("canvas");
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;

    const ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    Tesseract.recognize(canvas, "eng").then(({ data: { text } }) => {

        let clean = text.replace(/\n/g, " ").trim();

        // First two words only
        let words = clean.split(/\s+/);
        nameVal = words.slice(0, 2).join(" ");

        // Indian Pincode
        let pin = clean.match(/\b\d{6}\b/);
        pinVal = pin ? pin[0] : "";

        addRow();
    });
}

// ðŸ”¹ Add row
function addRow() {
    if (!barcodeVal) {
        alert("Scan barcode first");
        return;
    }

    document.getElementById("tbody").innerHTML += `
    <tr>
        <td>${sl++}</td>
        <td>${barcodeVal}</td>
        <td>${nameVal}</td>
        <td>${pinVal}</td>
    </tr>`;

    barcodeVal = "";
    nameVal = "";
    pinVal = "";
}
</script>

</body>
</html>
