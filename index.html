<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Letter Scanner</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<style>
    body { font-family: Arial; padding: 10px; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { border: 1px solid black; padding: 6px; text-align: center; }
    th { background: #eee; }
    video { width: 100%; border: 1px solid #000; }
    button { padding: 10px; margin-top: 8px; width: 100%; }
</style>
</head>

<body>

<h3>ðŸ“· Letter Barcode & Address Scanner</h3>

<video id="camera" autoplay></video>

<button onclick="startBarcode()">Scan Barcode</button>
<button onclick="scanLetter()">Scan Letter (Name & Pincode)</button>

<table>
<thead>
<tr>
    <th>Sl No</th>
    <th>Barcode</th>
    <th>Name</th>
    <th>Pincode</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>

<canvas id="canvas" style="display:none;"></canvas>

<script>
let slno = 1;
let barcodeValue = "";
let nameValue = "";
let pinValue = "";

// Camera start
navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
.then(stream => document.getElementById("camera").srcObject = stream);

// Barcode scanner
function startBarcode() {
    Quagga.init({
        inputStream: {
            name: "Live",
            type: "LiveStream",
            target: document.querySelector('#camera')
        },
        decoder: {
            readers: ["code_128_reader"]
        }
    }, function (err) {
        if (!err) Quagga.start();
    });

    Quagga.onDetected(result => {
        let code = result.codeResult.code.toUpperCase();
        let pattern = /^[A-Z]{2}[0-9]{9}[A-Z]{2}$/;

        if (pattern.test(code)) {
            barcodeValue = code;
            Quagga.stop();
            alert("Valid Barcode: " + code);
        }
    });
}

// OCR scan
function scanLetter() {
    const video = document.getElementById("camera");
    const canvas = document.getElementById("canvas");
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext("2d").drawImage(video, 0, 0);

    Tesseract.recognize(canvas, 'eng').then(({ data: { text } }) => {

        let cleanText = text.replace(/\n/g, " ").trim();

        // Name: first two words only
        let words = cleanText.split(/\s+/);
        nameValue = words.slice(0, 2).join(" ");

        // Indian Pincode (6 digits)
        let pinMatch = cleanText.match(/\b\d{6}\b/);
        pinValue = pinMatch ? pinMatch[0] : "";

        addRow();
    });
}

// Add row
function addRow() {
    if (!barcodeValue) {
        alert("Scan barcode first");
        return;
    }

    let row = `
    <tr>
        <td>${slno++}</td>
        <td>${barcodeValue}</td>
        <td>${nameValue}</td>
        <td>${pinValue}</td>
    </tr>`;

    document.getElementById("tableBody").innerHTML += row;

    barcodeValue = "";
    nameValue = "";
    pinValue = "";
}
</script>

</body>
</html>
