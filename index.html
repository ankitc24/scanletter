<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>India Post Envelope Scanner</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- OCR -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<!-- Excel Export -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
body {
    font-family: Arial, sans-serif;
    padding: 10px;
}

#cameraBox {
    width: 100%;
    height: 220px;
    border: 3px solid #1a73e8;
    margin: auto;
}

video {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

button {
    width: 100%;
    padding: 10px;
    margin-top: 6px;
    font-size: 16px;
}

table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
}

th, td {
    border: 1px solid black;
    padding: 6px;
    text-align: center;
}

th {
    background: #f2f2f2;
}

.delete-btn {
    background: red;
    color: white;
    border: none;
    padding: 4px 8px;
    cursor: pointer;
}
</style>
</head>

<body>

<h3 align="center">üìÆ India Post Envelope Scanner</h3>
<p align="center">Keep <b>‡§™‡•ç‡§∞‡§§‡§ø, Name & Pincode</b> visible</p>

<div id="cameraBox">
    <video id="video" autoplay playsinline muted></video>
</div>

<button onclick="startCamera()">Start Camera (Back)</button>
<button onclick="scan()">Scan Envelope</button>
<button onclick="exportExcel()">Export to Excel</button>

<table>
<thead>
<tr>
    <th>Sl No</th>
    <th>Name</th>
    <th>Pincode</th>
    <th>Action</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

<canvas id="canvas" style="display:none;"></canvas>

<script>
let sl = 1;
const video = document.getElementById("video");

// üî• FORCE BACK CAMERA
async function startCamera() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({
            video: {
                facingMode: { exact: "environment" }
            }
        });
        video.srcObject = stream;
    } catch (e) {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: "environment" }
            });
            video.srcObject = stream;
        } catch (err) {
            alert("Back camera not accessible. Allow camera permission.");
        }
    }
}

// üì∏ SCAN ENVELOPE
function scan() {
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0);

    Tesseract.recognize(canvas, "hin+eng").then(({ data: { text } }) => {

        let lines = text
            .split("\n")
            .map(l => l.trim())
            .filter(l => l !== "");

        let name = "";
        let pincode = "";

        // Extract NAME (first English line after "‡§™‡•ç‡§∞‡§§‡§ø")
        for (let i = 0; i < lines.length; i++) {
            if (/‡§™‡•ç‡§∞‡§§‡§ø/.test(lines[i]) && lines[i + 1]) {
                let words = lines[i + 1].match(/[A-Z]+/gi);
                if (words && words.length >= 2) {
                    name = words.slice(0, 2).join(" ");
                }
                break;
            }
        }

        // Extract PINCODE (6-digit)
        let pinMatch = text.match(/\b\d{6}\b/);
        if (pinMatch) pincode = pinMatch[0];

        if (!name && !pincode) {
            alert("Name or Pincode not detected. Adjust envelope & retry.");
            return;
        }

        addRow(name, pincode);
    });
}

// ‚ûï ADD ROW (LATEST ON TOP)
function addRow(name, pincode) {
    const tr = document.createElement("tr");
    tr.innerHTML = `
        <td>${sl++}</td>
        <td contenteditable="true">${name}</td>
        <td contenteditable="true">${pincode}</td>
        <td>
            <button class="delete-btn"
                onclick="this.closest('tr').remove()">Delete</button>
        </td>
    `;
    document.getElementById("tbody").prepend(tr);
}

// üì§ EXPORT TO EXCEL
function exportExcel() {
    const wb = XLSX.utils.table_to_book(
        document.querySelector("table"),
        { sheet: "Envelope Data" }
    );
    XLSX.writeFile(wb, "India_Post_Envelope_List.xlsx");
}
</script>

</body>
</html>
